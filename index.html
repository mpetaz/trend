<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Secondo Tempo (V13 - Approccio Misto)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .win { background-color: #dcfce7; color: #166534; }
        .lose { background-color: #fee2e2; color: #991b1b; }
        .pending { background-color: #fef9c3; color: #854d0e; }
        .na { background-color: #e5e7eb; color: #4b5563; } /* Stile per N/A */
        .table-cell { padding: 0.75rem; vertical-align: middle; }
        .loader-sm { /* ... stile loader ... */ }
        @keyframes spin { /* ... keyframes spin ... */ }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-lg w-full m-4">
            <div class="flex justify-between items-start">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="text-md text-gray-700 my-4"></div>
            <div class="flex justify-end gap-4 mt-6">
                 <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Annulla</button>
                 <button id="modal-confirm-btn" class="bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700">OK</button>
            </div>
        </div>
    </div>
    
     <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-md w-full m-4">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-bold text-gray-800">Modifica Dati Partita</h3>
                <button id="edit-modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p id="edit-modal-match-info" class="text-md text-gray-600 mt-2 mb-4"></p>
            <form id="edit-form">
                <input type="hidden" id="edit-row-id">
                <div class="mb-4">
                    <label for="edit-ft-score" class="block text-sm font-medium text-gray-700">Risultato Finale (FT)</label>
                    <input type="text" id="edit-ft-score" placeholder="Es. 2-1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                 <div class="mb-4">
                    <label for="edit-esito-2t" class="block text-sm font-medium text-gray-700">Esito 2T (VINTA/PERSA)</label>
                    <select id="edit-esito-2t" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        <option value="VINTA">VINTA</option>
                        <option value="PERSA">PERSA</option>
                        <option value="N/D">N/D</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="edit-ht-score" class="block text-sm font-medium text-gray-700">Risultato Primo Tempo (HT) - Opzionale</label>
                    <input type="text" id="edit-ht-score" placeholder="Es. 1-0 (lascia vuoto se N/A)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
            </form>
            <div class="text-right mt-6">
                 <button id="edit-modal-save-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600">Salva</button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
             <a href="./index.html" class="text-violet-600 hover:underline mb-4 block">&larr; Ricarica Pagina</a>
            <h1 class="text-4xl font-bold text-gray-900">Analisi Secondo Tempo</h1>
            <p class="text-lg text-gray-600 mt-2">Analizza i risultati del secondo tempo partendo dai dati Over 0.5 HT.</p>
        </header>

        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
             <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Caricamento Dati</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                 <div class="w-full">
                    <label for="st-file-uploader" class="block text-sm font-medium text-gray-700 mb-1">1. File Principale (0.5HT)</label>
                    <input type="file" id="st-file-uploader" accept=".csv" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                 </div>
                 <div class="w-full">
                    <label for="st-esito2t-uploader" class="block text-sm font-medium text-gray-700 mb-1">2. File Esito 2T (Opzionale)</label>
                    <input type="file" id="st-esito2t-uploader" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                 </div>
             </div>
             <div class="mt-6 text-center">
                 <button id="st-import-btn" class="w-full md:w-auto bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700 shadow-sm flex items-center gap-2 justify-center mx-auto">
                    <span class="btn-text">Carica e Unisci</span>
                    <div class="loader-sm hidden"></div>
                </button>
             </div>
        </div>

        <div id="st-results-container" class="hidden">
            <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                 </div>
             <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                 <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                     <h2 class="text-2xl font-semibold">Risultati Archivio Locale</h2>
                     <div class="flex gap-2">
                         <button id="st-calculate-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 text-sm flex items-center gap-2 justify-center">
                            <span class="btn-text">Calcola 2T Mancanti (API)</span>
                            <div class="loader-sm hidden"></div>
                        </button>
                        <button id="st-export-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm">Esporta CSV</button>
                        <button id="st-clear-db-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">Svuota Archivio</button>
                     </div>
                 </div>
             </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data</th>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Partita</th>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lega</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ris. FT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ris. HT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Esito 0.5HT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Esito 2T</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="st-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    
    <script type="module">
        // --- CONFIGURAZIONE CHIAVE API ---
        const API_KEY = "AIzaSyB9UHe0WirATu8KhHdH7dNdmcbhnaKKy6I";
        
        // --- Variabili Globali ---
        let stAnalyzedData = []; // Cache in memoria
        let db; // Riferimento al Database

        // --- NOMI DB ---
        const DB_NAME = "Analisi2TDB";
        const STORE_NAME = "partite";
        
        // --- Elementi del DOM ---
        const ui = {
            stFileUploader: document.getElementById('st-file-uploader'),
            stEsito2TUploader: document.getElementById('st-esito2t-uploader'), // Nuovo input
            stImportBtn: document.getElementById('st-import-btn'),
            stResultsContainer: document.getElementById('st-results-container'),
            stTotalPartite: document.getElementById('st-total-partite'),
            stPartiteVinte: document.getElementById('st-partite-vinte'),
            stPartitePerse: document.getElementById('st-partite-perse'),
            stPercentualeVinte: document.getElementById('st-percentuale-vinte'),
            stTableBody: document.getElementById('st-table-body'),
            stExportBtn: document.getElementById('st-export-btn'),
            stCalculateBtn: document.getElementById('st-calculate-btn'),
            stClearDbBtn: document.getElementById('st-clear-db-btn'), 
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            modalCloseBtnX: document.getElementById('modal-close-btn-x'),
            editModal: document.getElementById('edit-modal'),
            editModalMatchInfo: document.getElementById('edit-modal-match-info'),
            editModalCloseBtnX: document.getElementById('edit-modal-close-btn-x'),
            editModalSaveBtn: document.getElementById('edit-modal-save-btn'),
            editForm: document.getElementById('edit-form'),
            editRowId: document.getElementById('edit-row-id'),
            editFtScore: document.getElementById('edit-ft-score'),
            editEsito2T: document.getElementById('edit-esito-2t'),
            editHtScore: document.getElementById('edit-ht-score') // Campo HT ri-aggiunto
        };
        
        // --- Funzioni di Utility (invariate) ---
        const showLoaderOnButton = (button) => { /* ... */ };
        const hideLoaderOnButton = (button, originalText) => { /* ... */ };
        const showModal = (title, message, type = 'info', onConfirm = null) => { /* ... con modifiche per cancel */ };
        const hideModal = () => { /* ... */ };
        ui.modalConfirmBtn.addEventListener('click', hideModal);
        ui.modalCancelBtn.addEventListener('click', hideModal);
        ui.modalCloseBtnX.addEventListener('click', hideModal);
        
        // --- FUNZIONI DATABASE (INDEXEDDB - invariate) ---
        function initDB() { /* ... */ }
        function saveStData(data) { /* ... */ }
        function updateSingleRow(row) { /* ... */ }
        function loadStData() { /* ... */ }
        function clearDB() { /* ... */ }

        // --- Logica Avvio Pagina (invariata) ---
        window.addEventListener('load', async () => { /* ... */ });

        // --- Logica Principale ---
        
        // --- BLOCCO MODIFICATO: Logica "CARICA E UNISCI" con Doppio File ---
        ui.stImportBtn.addEventListener('click', async () => {
            const file1 = ui.stFileUploader.files[0]; // File principale 0.5HT
            const file2 = ui.stEsito2TUploader.files[0]; // File Esito 2T (opzionale)

            if (!file1) {
                showModal('Attenzione', "Seleziona almeno il file CSV principale (0.5HT).");
                return;
            }
            showLoaderOnButton(ui.stImportBtn);
            
            try {
                // 1. Carica dati DB esistenti
                const existingData = await loadStData();
                const dbMap = new Map(existingData.map(item => [item.id, item]));
                console.log(`Caricati ${dbMap.size} record esistenti dal DB.`);

                // 2. Processa il file Esito 2T (se presente)
                let esito2TMap = new Map();
                if (file2) {
                    console.log("Processo il file Esito 2T opzionale...");
                    esito2TMap = await parseEsito2TFile(file2);
                    console.log(`Trovati ${esito2TMap.size} esiti nel file Esito 2T.`);
                }

                // 3. Processa il file Principale e fa il merge
                console.log("Processo il file principale (0.5HT)...");
                const mergedData = await parseAndMergeMainFile(file1, dbMap, esito2TMap);
                console.log(`Merge completato. Risultato: ${mergedData.length} partite.`);

                // 4. Salva i dati uniti nel DB (sovrascrive)
                await saveStData(mergedData);
                stAnalyzedData = mergedData; // Aggiorna la cache in memoria

                // 5. Aggiorna UI
                updateStats();
                renderStTable(stAnalyzedData);
                ui.stResultsContainer.classList.remove('hidden');
                showModal('Unione Riuscita', `Caricate/Aggiornate ${stAnalyzedData.length} partite. Controlla la tabella e usa 'Calcola 2T Mancanti' se necessario.`);

            } catch (error) {
                console.error("Errore durante il caricamento/unione:", error);
                showModal('Errore di Caricamento', `Si è verificato un errore: ${error.message}`, 'error');
            } finally {
                hideLoaderOnButton(ui.stImportBtn, 'Carica e Unisci');
                // Resetta i campi file per permettere ricaricamenti
                ui.stFileUploader.value = ''; 
                ui.stEsito2TUploader.value = '';
            }
        });

        // Funzione helper per parsare il file Esito 2T (Opzionale)
        function parseEsito2TFile(file) {
            return new Promise((resolve, reject) => {
                const map = new Map();
                let headersChecked = false;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "windows-1252",
                    step: function(results) {
                        const row = results.data;
                        // Controllo colonne necessarie alla prima riga
                        if (!headersChecked) {
                            if (!row.hasOwnProperty('Data') || !row.hasOwnProperty('Partita') || !row.hasOwnProperty('Esito 2T (Betimes)')) {
                                parser.abort(); // Interrompe il parsing
                                return reject(new Error('Il file Esito 2T deve contenere le colonne "Data", "Partita", e "Esito 2T (Betimes)".'));
                            }
                            headersChecked = true;
                        }
                        
                        const matchId = `${row['Data']}-${row['Partita']}`;
                        const esito = (row['Esito 2T (Betimes)'] || '').toUpperCase(); // Normalizza
                        if (esito === 'VINTA' || esito === 'PERSA') {
                           map.set(matchId, esito);
                        } else {
                            console.warn(`Esito 2T non valido ('${row['Esito 2T (Betimes)']}') per ${matchId} nel file opzionale, verrà ignorato.`);
                        }
                    },
                    complete: function() {
                        resolve(map);
                    },
                    error: function(error) {
                        reject(new Error(`Errore durante il parsing del file Esito 2T: ${error.message}`));
                    }
                });
            });
        }

        // Funzione helper per parsare il file Principale e fare il merge
        function parseAndMergeMainFile(file, dbMap, esito2TMap) {
             return new Promise((resolve, reject) => {
                const mergedArray = [];
                let rowIndexCounter = 0; 
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "windows-1252",
                    step: function(results) {
                        const row = results.data;
                        let esitoValue = row['Esito (0,5HT)'] || row['Esito (0.5HT)'] || 'N/D';
                        for (const key in row) { if (typeof row[key] === 'string') { row[key] = row[key].replace(/\\s?/g, '').trim(); } }
                        const risultatoFinale = row['Risultato'] || ''; 

                        if (row['Data'] && row['Partita']) {
                            // ID Univoco per il DB basato su Data e Partita (più stabile)
                            const matchId = `${row['Data']}-${row['Partita']}`; 
                            
                            const newRow = {
                                id: matchId, // ID stabile
                                data: row['Data'],
                                lega: row['Lega'],
                                partita: row['Partita'],
                                risultatoFT: risultatoFinale, 
                                esito1T: esitoValue, 
                                risultatoHT: null, // Default
                                esito2T: 'PENDING' // Default
                            };

                            // Priorità 1: Esito dal file CSV opzionale
                            if (esito2TMap.has(matchId)) {
                                newRow.esito2T = esito2TMap.get(matchId);
                                newRow.risultatoHT = 'N/A'; // Non serve HT se abbiamo Esito 2T
                                console.log(`Merge: ${matchId} - Trovato Esito 2T (${newRow.esito2T}) nel file opzionale.`);
                            } else {
                                // Priorità 2: Esito dal DB (se già calcolato)
                                const existingRow = dbMap.get(matchId);
                                if (existingRow && existingRow.esito2T !== 'PENDING') {
                                    newRow.risultatoHT = existingRow.risultatoHT;
                                    newRow.esito2T = existingRow.esito2T;
                                     console.log(`Merge: ${matchId} - Mantenuto Esito 2T (${newRow.esito2T}) e HT (${newRow.risultatoHT}) dal DB.`);
                                } else {
                                    // Altrimenti rimane PENDING, verrà calcolato
                                     console.log(`Merge: ${matchId} - Nessun Esito 2T trovato, impostato su PENDING.`);
                                }
                            }
                            mergedArray.push(newRow);
                        } else {
                            console.warn("Riga saltata nel file principale per dati mancanti:", row);
                        }
                    },
                    complete: function() {
                        resolve(mergedArray);
                    },
                    error: function(error) {
                         reject(new Error(`Errore durante il parsing del file principale: ${error.message}`));
                    }
                });
            });
        }
        // --- FINE BLOCCO MODIFICATO ---


        // --- Logica Calcolo 2T (V11 - 0.5HT Ottimizzata) ---
        ui.stCalculateBtn.addEventListener('click', async () => {
            showLoaderOnButton(ui.stCalculateBtn);
            ui.stExportBtn.disabled = true;
            ui.stClearDbBtn.disabled = true;
            
            let googleCalls = 0;
            let rowsToUpdate = 0;
            let rowsSkipped = 0; 

            console.log("--- Inizio Calcolo Risultati 2T (API) ---");

            for(let i=0; i<stAnalyzedData.length; i++) {
                const row = stAnalyzedData[i];
                let rowUpdated = false;

                // Salta se non è PENDING
                if (row.esito2T !== 'PENDING') {
                    rowsSkipped++;
                    continue; 
                }

                console.log(`Processing riga ${i+1}: ${row.partita}, Esito1T: ${row.esito1T}, FT: ${row.risultatoFT}`);

                // 1. LOGICA PERSA (0-0 HT)
                if (row.esito1T === 'PERSA') {
                    console.log(`   -> Logica 0.5HT (PERSA). Imposto HT=0-0.`);
                    row.risultatoHT = '0-0';
                    if (row.risultatoFT && /^\d+-\d+$/.test(row.risultatoFT)) {
                         row.esito2T = (row.risultatoFT !== '0-0') ? 'VINTA' : 'PERSA';
                    } else { row.esito2T = 'N/D'; }
                    rowUpdated = true;
                
                // 2. LOGICA VINTA 1-0 / 0-1 (HT = FT)
                } else if (row.esito1T === 'VINTA' && (row.risultatoFT === '1-0' || row.risultatoFT === '0-1')) {
                    console.log(`   -> Logica 0.5HT (VINTA 1-0/0-1). Imposto HT = FT.`);
                    row.risultatoHT = row.risultatoFT;
                    row.esito2T = 'PERSA'; 
                    rowUpdated = true;

                // 3. LOGICA VINTA (ALTRI RISULTATI) -> Cerca su Google
                } else if (row.esito1T === 'VINTA') {
                    console.log(`   -> Logica 0.5HT (VINTA >1 gol). Chiamo Google...`);
                    const [home, away] = row.partita.split(' - ');
                    const dataPartita = new Date(row.data).toLocaleDateString('it-IT');
                    const query = `risultato primo tempo ${home} ${away} ${dataPartita} ${row.lega}`;
                    googleCalls++;
                    console.log(`      Query: ${query}`);
                    
                    try {
                        const result = await callGeminiAPI(query);
                        console.log(`      Risposta Gemini:`, result);
                        row.risultatoHT = result.ht_score || 'N/D';
                        
                        if (row.risultatoHT && row.risultatoHT !== 'N/D' && /^\d+-\d+$/.test(row.risultatoHT) && 
                            row.risultatoFT && /^\d+-\d+$/.test(row.risultatoFT)) {
                           const [ht1, ht2] = row.risultatoHT.split('-').map(Number);
                           const [ft1, ft2] = row.risultatoFT.split('-').map(Number);
                           const stGoals = (ft1 - ht1) + (ft2 - ht2);
                           row.esito2T = stGoals > 0 ? 'VINTA' : 'PERSA';
                           console.log(`      HT:${row.risultatoHT}, FT:${row.risultatoFT} => Gol 2T:${stGoals}, Esito2T:${row.esito2T}`);
                        } else {
                           row.esito2T = 'N/D';
                           console.warn(`      HT (${row.risultatoHT}) o FT (${row.risultatoFT}) non valido/trovato, Esito2T impostato a N/D`);
                        }
                    } catch (e) {
                         console.error(`      Errore Gemini per ${row.partita}:`, e);
                         row.esito2T = 'N/D';
                    }
                    rowUpdated = true;
                    await new Promise(resolve => setTimeout(resolve, 600)); 
                
                } else {
                     console.warn(`   -> Caso non gestito per ${row.partita}. Esito1T: ${row.esito1T}. Imposto N/D.`);
                     row.risultatoHT = 'N/D';
                     row.esito2T = 'N/D';
                     rowUpdated = true;
                }
                
                if (rowUpdated) {
                    rowsToUpdate++;
                    await updateSingleRow(row); // Salva la singola riga aggiornata nel DB
                    renderStTable(stAnalyzedData); // Aggiorna la UI
                }
            }
            
            console.log("--- Fine Calcolo Risultati 2T (API) ---");
            hideLoaderOnButton(ui.stCalculateBtn, 'Calcola 2T Mancanti (API)');
            ui.stExportBtn.disabled = false;
            ui.stClearDbBtn.disabled = false;
            showModal('Analisi Completata', `Calcolo API terminato. ${rowsToUpdate} righe elaborate. ${rowsSkipped} righe già presenti o fornite. Sono state effettuate ${googleCalls} nuove ricerche.`);
        });
        
         function renderStTable(data) {
            ui.stTableBody.innerHTML = '';
            data.forEach((m) => {
                let esito2TClass = 'pending'; // Default
                if (m.esito2T === 'VINTA') esito2TClass = 'win';
                if (m.esito2T === 'PERSA') esito2TClass = 'lose';
                if (m.esito2T === 'N/A') esito2TClass = 'na'; // Grigio per N/A da CSV

                let esito1TClass = 'pending';
                if (m.esito1T === 'VINTA') esito1TClass = 'win';
                if (m.esito1T === 'PERSA') esito1TClass = 'lose';

                // Mostra N/A per HT se non applicabile (preso da CSV 2T)
                const htDisplay = m.risultatoHT === 'N/A' ? 'N/A' : (m.risultatoHT || '...');

                const row = `
                    <tr class="hover:bg-gray-50" data-id="${m.id}">
                        <td class="table-cell text-sm text-gray-600">${new Date(m.data).toLocaleDateString('it-IT')}</td>
                        <td class="table-cell font-medium text-gray-900">${m.partita}</td>
                        <td class="table-cell text-sm text-gray-600">${m.lega}</td>
                        <td class="table-cell text-center font-mono">${m.risultatoFT}</td>
                        <td class="table-cell text-center font-mono ${m.risultatoHT === 'N/A' ? 'text-gray-400' : ''}">${htDisplay}</td>
                        <td class="table-cell text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${esito1TClass}">${m.esito1T}</span></td>
                        <td class="table-cell text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${esito2TClass}">${m.esito2T}</span></td>
                        <td class="table-cell text-center">
                             <div class="flex justify-center items-center gap-1">
                                <button class="edit-st-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${m.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="delete-st-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${m.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                ui.stTableBody.innerHTML += row;
            });
        }
        
         ui.stExportBtn.addEventListener('click', () => {
             if (stAnalyzedData.length === 0) { /* ... */ }
             // Esporta i dati attuali, includendo 'N/A' per HT se presente
             const exportData = stAnalyzedData.map(({ id, ...rest }) => rest); 
             let csvContent = "data:text/csv;charset=utf-8,";
             const headers = Object.keys(exportData[0]);
             csvContent += headers.join(",") + "\r\n";
             exportData.forEach(row => { /* ... */ });
             // ... (codice per creare e cliccare il link di download)
         });

        ui.stTableBody.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const rowId = button.dataset.id;
            const rowIndex = stAnalyzedData.findIndex(r => r.id === rowId);
            if (rowIndex === -1) return; 
            
            const rowData = stAnalyzedData[rowIndex];
            
            if (button.classList.contains('edit-st-btn')) {
                 ui.editRowId.value = rowId;
                 ui.editModalMatchInfo.textContent = rowData.partita;
                 ui.editFtScore.value = rowData.risultatoFT || '';
                 ui.editEsito2T.value = rowData.esito2T || 'N/D'; 
                 // Popola HT solo se non è 'N/A'
                 ui.editHtScore.value = (rowData.risultatoHT && rowData.risultatoHT !== 'N/A') ? rowData.risultatoHT : '';
                 ui.editModal.classList.remove('hidden');
            } else if (button.classList.contains('delete-st-btn')) {
                showModal('Conferma Cancellazione', `Sei sicuro di voler cancellare la partita: ${rowData.partita}?`, 'error', async () => {
                    stAnalyzedData.splice(rowIndex, 1);
                    await saveStData(stAnalyzedData); 
                    renderStTable(stAnalyzedData);
                    updateStats();
                });
            }
        });
        
        function updateStats() { /* ... */ }

        // Salva Modifiche dal Modal
        ui.editModalSaveBtn.addEventListener('click', async () => {
            const rowId = ui.editRowId.value;
            const rowIndex = stAnalyzedData.findIndex(r => r.id === rowId);
            if (rowIndex === -1) return;

            const ftScore = ui.editFtScore.value.trim();
            const esito2TValue = ui.editEsito2T.value; 
            const htScoreInput = ui.editHtScore.value.trim();
            // Se HT è vuoto o N/A, salvalo come N/A, altrimenti usa il valore se valido
            const htScore = (!htScoreInput || htScoreInput.toUpperCase() === 'N/A') ? 'N/A' 
                            : (/^\d+-\d+$/.test(htScoreInput) ? htScoreInput : 'N/D'); // Se inserito ma non valido -> N/D

            // Validazione: FT obbligatorio X-Y. HT opzionale X-Y.
            if (!/^\d+-\d+$/.test(ftScore)) {
                 showModal('Errore', 'Formato Risultato FT non valido (usa X-Y).', 'error');
                return;
            }
             if (htScoreInput && !/^\d+-\d+$/.test(htScoreInput)) {
                 showModal('Errore', 'Formato Risultato HT non valido (usa X-Y o lascia vuoto).', 'error');
                return;
            }


            const row = stAnalyzedData[rowIndex];
            row.risultatoFT = ftScore;
            row.esito2T = esito2TValue; 
            row.risultatoHT = htScore; // Salva HT corretto ('N/A', 'X-Y' o 'N/D')

            // Non serve ricalcolare Esito 2T, è preso dal select
            
            await updateSingleRow(row); // Salva modifica nel DB
            renderStTable(stAnalyzedData);
            ui.editModal.classList.add('hidden');
        });
        
        // Svuota Archivio
        ui.stClearDbBtn.addEventListener('click', () => { /* ... */ });
        
        // Funzione API (invariata)
        async function callGeminiAPI(userQuery, retries = 3) { /* ... */ }

    </script>
</body>
</html>