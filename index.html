<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendo - Gestione Pronostici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libreria per leggere i file XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .win { background-color: #dcfce7; color: #166534; }
        .lose { background-color: #fee2e2; color: #991b1b; }
        .pending { background-color: #fef9c3; color: #854d0e; }
        .fetching { background-color: #e0e7ff; color: #3730a3; }
        .table-cell { padding: 0.75rem; vertical-align: middle; }
        .filter-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.062 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em 1.25em;
            padding-right: 2rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader mx-auto mb-4"></div>
            <p id="loader-text" class="text-lg font-medium text-gray-700">Elaborazione in corso...</p>
        </div>
    </div>
    
    <!-- Modal Generico -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-2xl w-full m-4">
            <div class="flex justify-between items-start">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="text-md text-gray-700 my-4"></div>
            <div class="flex justify-end gap-4 mt-6">
                 <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition-all duration-200 shadow-sm hidden">
                    Annulla
                </button>
                 <button id="modal-confirm-btn" class="bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700 transition-all duration-200 shadow-sm">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Modifica Risultato -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-md w-full m-4">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-bold text-gray-800">Modifica Risultato</h3>
                <button id="edit-modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p id="edit-modal-match-info" class="text-md text-gray-600 mt-2 mb-4"></p>
            <form id="edit-form">
                <input type="hidden" id="edit-doc-id">
                <div class="mb-4">
                    <label for="edit-ft-score" class="block text-sm font-medium text-gray-700">Risultato Finale (FT)</label>
                    <input type="text" id="edit-ft-score" placeholder="Es. 2-1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-violet-500 focus:border-violet-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-ht-score" class="block text-sm font-medium text-gray-700">Risultato Primo Tempo (HT)</label>
                    <input type="text" id="edit-ht-score" placeholder="Es. 1-0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-violet-500 focus:border-violet-500 sm:text-sm">
                </div>
            </form>
            <div class="text-right mt-6">
                 <button id="edit-modal-save-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-all duration-200 shadow-sm">
                    Salva Modifiche
                </button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Trendo - Gestione Pronostici</h1>
            <p class="text-lg text-gray-600 mt-2">Importa i tuoi pronostici e aggiorna i risultati con un click.</p>
        </header>

        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Pannello di Controllo</h2>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <!-- Sezione Importazione -->
                <div class="flex-1 w-full">
                    <label for="file-uploader" class="block text-sm font-medium text-gray-700 mb-1">1. Carica il tuo file (.xlsx o .csv)</label>
                    <input type="file" id="file-uploader" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition-colors duration-200">
                </div>
                <button id="import-btn" class="w-full md:w-auto bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700 transition-all duration-200 shadow-sm disabled:bg-gray-400" disabled>
                    Importa Dati
                </button>

                <!-- Sezione Aggiornamento -->
                <div class="border-t md:border-t-0 md:border-l border-gray-200 my-4 md:my-0 md:mx-4 h-auto md:h-12"></div>
                
                <div class="flex-1 w-full text-center md:text-left">
                     <p class="text-sm font-medium text-gray-700 mb-1">2. Aggiorna Risultati</p>
                    <p class="text-xs text-gray-500 mb-2">Cerca i risultati per le partite passate e non ancora definite.</p>
                </div>
                <button id="fetch-results-btn" class="w-full md:w-auto bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-all duration-200 shadow-sm disabled:bg-gray-400" disabled>
                    âœ¨ Aggiorna Risultati
                </button>
            </div>
             <p id="user-id-display" class="text-xs text-gray-400 mt-4 text-center"></p>
        </div>
        
        <!-- Filtri e Azioni -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Filtri e Azioni Avanzate</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Sezione Filtri -->
                <div>
                    <h3 class="text-lg font-medium mb-2">Filtra per Data</h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Da</label>
                            <input type="date" id="start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">A</label>
                            <input type="date" id="end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500">
                        </div>
                    </div>
                </div>
                <!-- Sezione Azioni Pericolose -->
                <div>
                    <h3 class="text-lg font-medium mb-2 text-red-700">Azioni di Cancellazione</h3>
                     <div class="flex flex-col sm:flex-row gap-4">
                        <button id="delete-filtered-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-all duration-200 shadow-sm">Cancella Dati Filtrati</button>
                        <button id="delete-all-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all duration-200 shadow-sm">Cancella Tutto</button>
                    </div>
                     <p class="text-xs text-gray-500 mt-2">Attenzione: queste azioni sono irreversibili.</p>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="filter-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-sm text-sm">Applica Filtri</button>
                <button id="clear-filter-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all duration-200 shadow-sm text-sm">Rimuovi Tutti i Filtri</button>
            </div>
        </div>


        <!-- Tabella Pronostici -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data</th>
                            <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    Campionato
                                    <select id="campionato-filter" class="ml-2 block w-full border-gray-300 rounded-md shadow-sm text-xs focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </th>
                            <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Partita</th>
                            <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Risultato</th>
                            <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    Mercato
                                    <select id="mercato-filter" class="ml-2 block w-full border-gray-300 rounded-md shadow-sm text-xs focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </th>
                            <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center justify-center">
                                    Esito
                                    <select id="esito-filter" class="ml-2 block w-full border-gray-300 rounded-md shadow-sm text-xs focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                            </th>
                            <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tips-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Le righe verranno inserite qui da JavaScript -->
                        <tr><td colspan="7" class="text-center p-8 text-gray-500">Connessione a Firebase in corso...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTPCU1Cwg3U3qcGmrhg_Vr6NBL1kgZrrw",
            authDomain: "trend-betmines.firebaseapp.com",
            projectId: "trend-betmines",
            storageBucket: "trend-betmines.firebasestorage.app",
            messagingSenderId: "1075169451180",
            appId: "1:1075169451180:web:57f32cc1fcade158ebd309"
        };
        
        // --- Import delle librerie Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, updateDoc, doc, serverTimestamp, orderBy, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Inizializzazione ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Variabili Globali ---
        let userId = null;
        let allTips = [];
        let currentFilters = { startDate: null, endDate: null, campionato: '', mercato: '', esito: '' };
        const TIPS_COLLECTION = 'pronostici-sportivi';
        const MESE = { "gen":1,"feb":2,"mar":3,"apr":4,"mag":5,"giu":6,"lug":7,"ago":8,"set":9,"ott":10,"nov":11,"dic":12 };
        const NAZIONI_MAP = {
            "russia": "RUS", "mexico": "MEX", "netherlands": "NED", "spain": "SPA", "england": "ENG", 
            "portugal": "POR", "turkey": "TUR", "colombia": "COL", "poland": "POL", "saudi arabia": "KSA",
            "france": "FRA", "italy": "ITA", "germany": "GER", "brazil": "BRA", "argentina": "ARG"
        };

        // --- Elementi del DOM ---
        const fileUploader = document.getElementById('file-uploader');
        const importBtn = document.getElementById('import-btn');
        const fetchResultsBtn = document.getElementById('fetch-results-btn');
        const tipsTableBody = document.getElementById('tips-table-body');
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        
        // Modal Generico
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalCloseBtnX = document.getElementById('modal-close-btn-x');

        // Modal di Modifica
        const editModal = document.getElementById('edit-modal');
        const editModalMatchInfo = document.getElementById('edit-modal-match-info');
        const editModalCloseBtnX = document.getElementById('edit-modal-close-btn-x');
        const editModalSaveBtn = document.getElementById('edit-modal-save-btn');
        const editForm = document.getElementById('edit-form');
        const editDocId = document.getElementById('edit-doc-id');
        const editFtScore = document.getElementById('edit-ft-score');
        const editHtScore = document.getElementById('edit-ht-score');

        // Filtri e Azioni
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const deleteFilteredBtn = document.getElementById('delete-filtered-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        
        // Filtri Colonna
        const campionatoFilter = document.getElementById('campionato-filter');
        const mercatoFilter = document.getElementById('mercato-filter');
        const esitoFilter = document.getElementById('esito-filter');


        // --- Funzioni di Utility ---
        const showLoader = (text) => {
            loaderText.textContent = text;
            loaderOverlay.classList.remove('hidden');
        };
        const hideLoader = () => {
            loaderOverlay.classList.add('hidden');
        };

        const showModal = (title, message, type = 'info', onConfirm = null) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = message;
            
            modalConfirmBtn.onclick = onConfirm || hideModal;
            modalConfirmBtn.textContent = onConfirm ? 'Conferma' : 'OK';
            modalCancelBtn.style.display = onConfirm ? 'inline-block' : 'none';

            const titleBaseClasses = 'text-xl font-bold';
            const buttonBaseClasses = 'text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 shadow-sm';
            
            if (type === 'error') {
                modalTitle.className = `${titleBaseClasses} text-red-700`;
                modalConfirmBtn.className = `${buttonBaseClasses} bg-red-600 hover:bg-red-700`;
            } else {
                modalTitle.className = `${titleBaseClasses} text-gray-800`;
                modalConfirmBtn.className = `${buttonBaseClasses} bg-violet-600 hover:bg-violet-700`;
            }
            
            modal.classList.remove('hidden');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
        }

        modalConfirmBtn.addEventListener('click', hideModal);
        modalCancelBtn.addEventListener('click', hideModal);
        modalCloseBtnX.addEventListener('click', hideModal);

        function estraiDataOra(txt) {
            if (!txt || typeof txt !== 'string') return null;
            const dateRegex = /(\d{1,2})\s+([a-zÃ ]+)\s+(\d{4})/;
            const timeRegex = /(\d{1,2}:\d{2})/;
            const dateMatch = txt.match(dateRegex);
            const timeMatch = txt.match(timeRegex);

            if (!dateMatch) return null;
            
            const g = parseInt(dateMatch[1]);
            const meseStr = dateMatch[2].substring(0, 3).toLowerCase();
            const anno = parseInt(dateMatch[3]);
            const mese = MESE[meseStr];

            if (!mese) return null;
            
            const [ore, minuti] = timeMatch ? timeMatch[1].split(':').map(Number) : [0, 0];
            
            const date = new Date(anno, mese - 1, g, ore, minuti);
            return date;
        }

        // --- Autenticazione ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = `UserID: ${userId}`;
                importBtn.disabled = false;
                fetchResultsBtn.disabled = false;
                listenToTips();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Errore di autenticazione anonima:", error);
                     showModal('Errore di Autenticazione', `Impossibile connettersi. Dettagli: ${error.message}`, 'error');
                });
            }
        });
        
        // --- Logica Principale ---
        
        // 1. Ascolta i dati da Firestore
        function listenToTips() {
            if (!userId) return;
            const q = query(collection(db, TIPS_COLLECTION), where("userId", "==", userId));
            
            onSnapshot(q, (querySnapshot) => {
                allTips = [];
                querySnapshot.forEach((doc) => {
                    allTips.push({ id: doc.id, ...doc.data() });
                });
                populateColumnFilters();
                applyFiltersAndRender();
            }, (error) => {
                console.error("Errore nell'ascolto dei dati:", error);
                if (error.message.includes("requires an index")) {
                     const link = `https://console.firebase.google.com/v1/r/project/trend-betmines/firestore/indexes?create_composite=Clpwcm9qZWN0cy90cmVuZC1iZXRtaW5lcy9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvcHJvbm9zdGljaS1zcG9ydGl2aS9pbmRleGVzL18QARoKCgZ1c2VySWQQARoOCgpob21lVGVhbRABGg0KCWF3YXlUZWFtEAESGg0KCW1hdGNoRGF0ZRABGgwKCF9fbmFtZV9fEAE`;
                     showModal('Configurazione Richiesta', `Per evitare duplicati, Firebase ha bisogno di un nuovo indice. <a href="${link}" target="_blank" class="text-blue-600 hover:underline font-bold">Clicca qui</a>, attendi che la pagina carichi, e clicca su "Crea".`, 'error');
                } else {
                    showModal('Errore Database', `Impossibile caricare i dati da Firestore: ${error.message}`, 'error');
                }
            });
        }
        
        // 2. Applica tutti i filtri e renderizza la tabella
        function applyFiltersAndRender() {
            let filteredTips = [...allTips];
            
            // Filtro per data
            if (currentFilters.startDate) {
                filteredTips = filteredTips.filter(tip => (tip.matchDate.seconds * 1000) >= currentFilters.startDate.getTime());
            }
            if (currentFilters.endDate) {
                filteredTips = filteredTips.filter(tip => (tip.matchDate.seconds * 1000) <= currentFilters.endDate.getTime());
            }

            // Filtri per colonna
            if (currentFilters.campionato) {
                filteredTips = filteredTips.filter(tip => tip.campionato === currentFilters.campionato);
            }
            if (currentFilters.mercato) {
                filteredTips = filteredTips.filter(tip => tip.market === currentFilters.mercato);
            }
            if (currentFilters.esito) {
                filteredTips = filteredTips.filter(tip => {
                    if (currentFilters.esito === 'V') return tip.outcome === 'V';
                    if (currentFilters.esito === 'P') return tip.outcome === 'P';
                    if (currentFilters.esito === 'N/D') return tip.status === 'completed' && !tip.outcome;
                    if (currentFilters.esito === 'Attesa') return tip.status === 'pending' || tip.status === 'fetching';
                    return false;
                });
            }
            
            filteredTips.sort((a, b) => (b.matchDate?.seconds || 0) - (a.matchDate?.seconds || 0));
            renderTable(filteredTips);
        }

        // 3. Renderizza la tabella
        function renderTable(tips) {
            tipsTableBody.innerHTML = '';
            if (tips.length === 0) {
                tipsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Nessun dato corrisponde ai filtri selezionati.</td></tr>';
                return;
            }

            tips.forEach(tip => {
                let esitoClass = 'pending';
                let esitoText = 'Attesa';
                if (tip.status === 'fetching') {
                    esitoClass = 'fetching';
                    esitoText = 'Cerca...';
                } else if (tip.outcome === 'V') {
                    esitoClass = 'win';
                    esitoText = 'Vinto';
                } else if (tip.outcome === 'P') {
                    esitoClass = 'lose';
                    esitoText = 'Perso';
                } else if (tip.status === 'completed' && !tip.outcome) {
                     esitoClass = 'pending';
                     esitoText = 'N/D';
                }

                const row = `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="table-cell text-sm text-gray-600">${tip.matchDate && tip.matchDate.seconds ? new Date(tip.matchDate.seconds * 1000).toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Data non valida'}</td>
                        <td class="table-cell text-sm text-gray-500">${tip.campionato || ''}</td>
                        <td class="table-cell font-medium text-gray-900">${tip.homeTeam || ''} - ${tip.awayTeam || ''}</td>
                        <td class="table-cell text-center font-mono text-gray-700">
                            <div>FT: ${tip.resultFT || '-'}</div>
                            <div class="text-xs">HT: ${tip.resultHT || '-'}</div>
                        </td>
                        <td class="table-cell text-sm text-gray-600">${tip.market ? String(tip.market) : ''}</td>
                        <td class="table-cell text-center">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${esitoClass}">
                                ${esitoText}
                            </span>
                        </td>
                        <td class="table-cell text-center">
                            <button class="edit-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${tip.id}" data-hometeam="${tip.homeTeam}" data-awayteam="${tip.awayTeam}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                tipsTableBody.innerHTML += row;
            });
        }
        
        // 4. Popola i filtri delle colonne
        function populateColumnFilters() {
            const campionati = [...new Set(allTips.map(tip => tip.campionato).filter(c => c))].sort();
            const mercati = [...new Set(allTips.map(tip => tip.market).filter(m => m))].sort();
            const esiti = ['Vinto', 'Perso', 'Attesa', 'N/D'];

            const populate = (select, options, valueMap = null) => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Tutti</option>';
                options.forEach(opt => {
                    const optionValue = valueMap ? valueMap[opt] : opt;
                    const selected = optionValue === currentValue ? 'selected' : '';
                    select.innerHTML += `<option value="${optionValue}" ${selected}>${opt}</option>`;
                });
            };
            
            populate(campionatoFilter, campionati);
            populate(mercatoFilter, mercati);
            populate(esitoFilter, esiti, { 'Vinto': 'V', 'Perso': 'P', 'Attesa': 'Attesa', 'N/D': 'N/D' });
        }


        // 5. Gestione importazione XLSX/CSV (con controllo duplicati)
        importBtn.addEventListener('click', async () => {
            const file = fileUploader.files[0];
            if (!file) {
                showModal('Attenzione', "Per favore, seleziona un file.");
                return;
            }

            showLoader('Importazione dati in corso...');
            importBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const data = event.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                let importedCount = 0;
                let skippedCount = 0;

                for (let i = 1; i < rows.length; i++) {
                    const columns = rows[i];
                    if (columns.length < 8) continue;

                    try {
                        const homeTeam = (columns[4] || '').replace('ðŸ†š', '').trim();
                        const awayTeam = (columns[5] || '').trim();
                        const matchDateStr = columns[6];
                        let market = columns[7];
                        const messaggioCompleto = columns[14] || '';

                        let campionato = '';
                        const campionatoRegex = /ðŸ†\s*(.+)/;
                        const match = messaggioCompleto.match(campionatoRegex);
                        if (match && match[1]) {
                           const parts = match[1].split(',').map(s => s.trim());
                           if (parts.length > 1) {
                               const nazione = parts.pop();
                               const siglaNazione = NAZIONI_MAP[nazione.toLowerCase()] || nazione.substring(0,3).toUpperCase();
                               campionato = `${siglaNazione} - ${parts.join(', ')}`;
                           } else {
                               campionato = parts[0];
                           }
                        }
                        
                        if (!homeTeam || !awayTeam || !matchDateStr || !market) continue;
                        
                        market = String(market).replace('ðŸŽ¯', '').replace('Mercato:', '').trim();

                        const matchDate = estraiDataOra(matchDateStr);
                        if (!matchDate) continue;

                        // --- CONTROLLO DUPLICATI ---
                        const q = query(collection(db, TIPS_COLLECTION), 
                            where("userId", "==", userId),
                            where("homeTeam", "==", homeTeam),
                            where("awayTeam", "==", awayTeam),
                            where("matchDate", "==", matchDate)
                        );
                        const existingDoc = await getDocs(q);
                        if (!existingDoc.empty) {
                            skippedCount++;
                            continue; 
                        }
                        // --- FINE CONTROLLO ---

                        const newTip = {
                            userId,
                            homeTeam,
                            awayTeam,
                            matchDate,
                            campionato,
                            market,
                            status: 'pending',
                            resultFT: null,
                            resultHT: null,
                            outcome: null,
                            sourceMessage: messaggioCompleto,
                            createdAt: serverTimestamp()
                        };
                        
                        await addDoc(collection(db, TIPS_COLLECTION), newTip);
                        importedCount++;

                    } catch (e) {
                        console.error("Errore nell'elaborazione della riga:", columns, e);
                    }
                }
                hideLoader();
                showModal('Operazione Completata', `Importazione completata! ${importedCount} nuovi pronostici aggiunti. ${skippedCount} duplicati sono stati ignorati.`);
                importBtn.disabled = false;
                fileUploader.value = '';
            };
            reader.readAsArrayBuffer(file);
        });

        // 6. Gestione aggiornamento risultati
        fetchResultsBtn.addEventListener('click', async () => {
            if (!userId) return;

            showLoader('Ricerca risultati in corso...');
            fetchResultsBtn.disabled = true;

            const now = new Date();
            const q = query(collection(db, TIPS_COLLECTION), 
                where("userId", "==", userId), 
                where("status", "==", "pending"),
                where("matchDate", "<", now)
            );

            const querySnapshot = await getDocs(q);
            const pendingTips = [];
            querySnapshot.forEach(doc => pendingTips.push({ id: doc.id, ...doc.data() }));

            if (pendingTips.length === 0) {
                showModal("Nessun Aggiornamento", "Non ci sono partite passate in attesa di risultato.");
                hideLoader();
                fetchResultsBtn.disabled = false;
                return;
            }
            
            let updatedCount = 0;
            for (const tip of pendingTips) {
                await updateDoc(doc(db, TIPS_COLLECTION, tip.id), { status: 'fetching' });

                const dateString = new Date(tip.matchDate.seconds * 1000).toLocaleDateString('it-IT');
                const userQuery = `Qual Ã¨ stato il risultato finale (FT) e del primo tempo (HT) della partita di calcio tra ${tip.homeTeam} e ${tip.awayTeam} giocata il ${dateString}?`;
                
                try {
                    const result = await callGeminiAPI(userQuery);
                    
                    const { ft_score, ht_score } = result;

                    if (ft_score) {
                        const outcome = calcolaEsito(ht_score, ft_score, tip.market);
                        await updateDoc(doc(db, TIPS_COLLECTION, tip.id), {
                            resultFT: ft_score,
                            resultHT: ht_score,
                            outcome: outcome,
                            status: 'completed'
                        });
                        updatedCount++;
                    } else {
                         await updateDoc(doc(db, TIPS_COLLECTION, tip.id), { status: 'completed' });
                    }
                } catch (error) {
                    console.error("Errore API per la partita:", tip.homeTeam, error);
                    await updateDoc(doc(db, TIPS_COLLECTION, tip.id), { status: 'pending' });
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            hideLoader();
            showModal('Operazione Completata', `Aggiornamento terminato! ${updatedCount} risultati sono stati trovati e aggiornati.`);
            fetchResultsBtn.disabled = false;
        });

        async function callGeminiAPI(userQuery) {
            const apiKey = "AIzaSyCTPCU1Cwg3U3qcGmrhg_Vr6NBL1kgZrrw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `Sei un assistente per dati sportivi. Rispondi SEMPRE E SOLO con un oggetto JSON. Il JSON deve avere le chiavi "ft_score" e "ht_score". Se trovi entrambi i risultati, valorizzali come stringhe (es. "2-1"). Se non trovi un risultato, il suo valore deve essere null. Esempio di risposta corretta: {"ft_score": "3-0", "ht_score": "1-0"}. Esempio se non trovi il risultato: {"ft_score": null, "ht_score": null}. Non aggiungere mai altro testo o spiegazioni.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) return { ft_score: null, ht_score: null };
            
            try {
                const cleanText = text.replace(/```json\n?|\n?```/g, '');
                return JSON.parse(cleanText);
            } catch (e) {
                 console.error("Errore nel parsing del JSON:", text);
                 return { ft_score: null, ht_score: null };
            }
        }

        // 7. Funzione per calcolare l'esito (con logica migliorata)
        function calcolaEsito(risHT, risFT, mercato) {
            if (!risFT || !mercato) return "";
            try {
                const [g1, g2] = risFT.split("-").map(Number);
                const [ht1, ht2] = (risHT || "0-0").split("-").map(Number);

                let cleanMarket = String(mercato).toLowerCase().trim();

                const isVittoriaCasa = cleanMarket === '1' || cleanMarket.includes('vittoria in casa');
                const isVittoriaTrasferta = cleanMarket === '2' || cleanMarket.includes('vittoria in trasferta') || cleanMarket.includes('vittoria trasferta');
                const isPareggio = cleanMarket === 'x';

                if (isVittoriaCasa) return g1 > g2 ? "V" : "P";
                if (isVittoriaTrasferta) return g1 < g2 ? "V" : "P";
                if (isPareggio) return g1 === g2 ? "V" : "P";

                if (cleanMarket.includes("1x2") && cleanMarket.includes("finale")) {
                    if (cleanMarket.includes(" 1")) return g1 > g2 ? "V" : "P";
                    if (cleanMarket.includes(" x")) return g1 === g2 ? "V" : "P";
                    if (cleanMarket.includes(" 2")) return g1 < g2 ? "V" : "P";
                }
                else if (cleanMarket.includes("doppia chance")) {
                    if (cleanMarket.includes("1x")) return g1 >= g2 ? "V" : "P";
                    if (cleanMarket.includes("x2")) return g1 <= g2 ? "V" : "P";
                    if (cleanMarket.includes("12")) return g1 !== g2 ? "V" : "P";
                }
                else if (cleanMarket.includes("oltre") || cleanMarket.includes("meno")) {
                    const valueMatch = cleanMarket.match(/(\d+\.\d+)/);
                    if (!valueMatch) return "";
                    const value = parseFloat(valueMatch[1]);
                    if (cleanMarket.includes("oltre")) return (g1 + g2) > value ? "V" : "P";
                    if (cleanMarket.includes("meno")) return (g1 + g2) < value ? "V" : "P";
                }
                else if (cleanMarket.includes("gol/no gol") || cleanMarket.includes("entrambe le squadre segnano")) {
                    if (cleanMarket.includes("si") || cleanMarket.includes("gol")) return g1 > 0 && g2 > 0 ? "V" : "P";
                    if (cleanMarket.includes("no")) return g1 === 0 || g2 === 0 ? "V" : "P";
                }
                else if (cleanMarket.includes("pari/dispari")) {
                    if (cleanMarket.includes("pari")) return (g1 + g2) % 2 === 0 ? "V" : "P";
                    if (cleanMarket.includes("dispari")) return (g1 + g2) % 2 !== 0 ? "V" : "P";
                }
                else if (cleanMarket.includes("primo tempo")) {
                    if (cleanMarket.includes("oltre 0.5")) return (ht1 + ht2) > 0.5 ? "V" : "P";
                }

            } catch (e) {
                console.error("Errore in calcolaEsito:", e);
                return "";
            }
            return "";
        }
        
        // 8. Logica per il modal di modifica
        tipsTableBody.addEventListener('click', (event) => {
            const editButton = event.target.closest('.edit-btn');
            if (editButton) {
                const docId = editButton.dataset.id;
                const homeTeam = editButton.dataset.hometeam;
                const awayTeam = editButton.dataset.awayteam;
                
                editDocId.value = docId;
                editModalMatchInfo.textContent = `${homeTeam} vs ${awayTeam}`;
                editForm.reset();
                editModal.classList.remove('hidden');
            }
        });

        editModalCloseBtnX.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        editModalSaveBtn.addEventListener('click', async () => {
            const docId = editDocId.value;
            const ftScore = editFtScore.value.trim();
            const htScore = editHtScore.value.trim();

            if (!docId || !ftScore) {
                showModal('Errore', 'Il risultato finale (FT) Ã¨ obbligatorio.', 'error');
                return;
            }
            if (!/^\d+-\d+$/.test(ftScore) || (htScore && !/^\d+-\d+$/.test(htScore))) {
                 showModal('Errore', 'Formato risultato non valido. Usa il formato "X-Y" (es. 2-1).', 'error');
                return;
            }
            
            showLoader("Salvataggio in corso...");
            
            const tipRef = doc(db, TIPS_COLLECTION, docId);
            const tipDoc = await getDoc(tipRef);
            const tipData = tipDoc.data();

            const outcome = calcolaEsito(htScore, ftScore, tipData.market);
            
            await updateDoc(tipRef, {
                resultFT: ftScore,
                resultHT: htScore || null,
                outcome: outcome,
                status: 'completed'
            });
            
            hideLoader();
            editModal.classList.add('hidden');
        });

        // 9. Logica Filtri
        function applyAllFilters() {
             const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0); 
            
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            if (endDate) endDate.setHours(23, 59, 59, 999);
            
            currentFilters = {
                startDate,
                endDate,
                campionato: campionatoFilter.value,
                mercato: mercatoFilter.value,
                esito: esitoFilter.value
            };
            applyFiltersAndRender();
        }
        
        filterBtn.addEventListener('click', applyAllFilters);
        campionatoFilter.addEventListener('change', applyAllFilters);
        mercatoFilter.addEventListener('change', applyAllFilters);
        esitoFilter.addEventListener('change', applyAllFilters);

        clearFilterBtn.addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            campionatoFilter.value = '';
            mercatoFilter.value = '';
            esitoFilter.value = '';
            applyAllFilters();
        });
        
        deleteAllBtn.addEventListener('click', () => {
            showModal(
                'Conferma Cancellazione Totale', 
                'Sei assolutamente sicuro di voler cancellare TUTTI i pronostici dal database? L\'azione Ã¨ irreversibile.', 
                'error',
                async () => {
                    showLoader('Cancellazione di tutti i dati in corso...');
                    const q = query(collection(db, TIPS_COLLECTION), where("userId", "==", userId));
                    const snapshot = await getDocs(q);
                    const docsToDelete = snapshot.docs;
                    const batchSize = 499; // Max 500, usiamo un po' meno per sicurezza
                    const numBatches = Math.ceil(docsToDelete.length / batchSize);

                    for (let i = 0; i < numBatches; i++) {
                        showLoader(`Cancellazione di tutti i dati in corso... (blocco ${i + 1} di ${numBatches})`);
                        const batch = writeBatch(db);
                        const chunk = docsToDelete.slice(i * batchSize, (i + 1) * batchSize);
                        chunk.forEach(docRef => {
                            batch.delete(docRef.ref);
                        });
                        await batch.commit();
                    }
                    
                    hideLoader();
                    showModal('Operazione Completata', 'Tutti i dati sono stati cancellati con successo.');
                }
            );
        });
        
        deleteFilteredBtn.addEventListener('click', () => {
            const filteredTips = allTips.filter(tip => {
                 let pass = true;
                if (currentFilters.startDate && (tip.matchDate.seconds * 1000) < currentFilters.startDate.getTime()) pass = false;
                if (currentFilters.endDate && (tip.matchDate.seconds * 1000) > currentFilters.endDate.getTime()) pass = false;
                if (currentFilters.campionato && tip.campionato !== currentFilters.campionato) pass = false;
                if (currentFilters.mercato && tip.market !== currentFilters.mercato) pass = false;
                if (currentFilters.esito) {
                    if (currentFilters.esito === 'V' && tip.outcome !== 'V') pass = false;
                    if (currentFilters.esito === 'P' && tip.outcome !== 'P') pass = false;
                    if (currentFilters.esito === 'N/D' && !(tip.status === 'completed' && !tip.outcome)) pass = false;
                    if (currentFilters.esito === 'Attesa' && !(tip.status === 'pending' || tip.status === 'fetching')) pass = false;
                }
                return pass;
            });

            if (filteredTips.length === 0) {
                 showModal('Azione non possibile', 'Nessun dato corrisponde ai filtri attuali. Impossibile cancellare.', 'error');
                return;
            }

            showModal(
                'Conferma Cancellazione Filtrati', 
                `Sei sicuro di voler cancellare i ${filteredTips.length} pronostici visualizzati? L'azione Ã¨ irreversibile.`, 
                'error',
                async () => {
                    showLoader(`Cancellazione di ${filteredTips.length} dati in corso...`);
                    const batchSize = 499;
                    const numBatches = Math.ceil(filteredTips.length / batchSize);

                    for (let i = 0; i < numBatches; i++) {
                        showLoader(`Cancellazione dei dati filtrati in corso... (blocco ${i + 1} di ${numBatches})`);
                        const batch = writeBatch(db);
                        const chunk = filteredTips.slice(i * batchSize, (i + 1) * batchSize);
                        chunk.forEach(tip => {
                            const docRef = doc(db, TIPS_COLLECTION, tip.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                    }

                    hideLoader();
                    showModal('Operazione Completata', `${filteredTips.length} dati sono stati cancellati.`);
                }
            );
        });

    </script>
</body>
</html>

