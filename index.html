<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Secondo Tempo (V10.3 - UI/ID Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .win { background-color: #dcfce7; color: #166534; }
        .lose { background-color: #fee2e2; color: #991b1b; }
        .pending { background-color: #fef9c3; color: #854d0e; }
        .table-cell { padding: 0.75rem; vertical-align: middle; }
        .loader-sm {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-lg w-full m-4">
            <div class="flex justify-between items-start">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="text-md text-gray-700 my-4"></div>
            <div class="flex justify-end gap-4 mt-6">
                 <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 hidden">Annulla</button>
                 <button id="modal-confirm-btn" class="bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700">OK</button>
            </div>
        </div>
    </div>
    
     <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-left max-w-md w-full m-4">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-bold text-gray-800">Modifica Risultato</h3>
                <button id="edit-modal-close-btn-x" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p id="edit-modal-match-info" class="text-md text-gray-600 mt-2 mb-4"></p>
            <form id="edit-form">
                <input type="hidden" id="edit-row-id">
                <div class="mb-4">
                    <label for="edit-ft-score" class="block text-sm font-medium text-gray-700">Risultato Finale (FT)</label>
                    <input type="text" id="edit-ft-score" placeholder="Es. 2-1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="edit-ht-score" class="block text-sm font-medium text-gray-700">Risultato Primo Tempo (HT)</label>
                    <input type="text" id="edit-ht-score" placeholder="Es. 1-0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
            </form>
            <div class="text-right mt-6">
                 <button id="edit-modal-save-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600">Salva</button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
             <a href="./index.html" class="text-violet-600 hover:underline mb-4 block">&larr; Ricarica Pagina</a>
            <h1 class="text-4xl font-bold text-gray-900">Analisi Secondo Tempo</h1>
            <p class="text-lg text-gray-600 mt-2">Analizza i risultati del secondo tempo partendo dai dati Over 0.5 HT.</p>
        </header>

        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
             <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Caricamento Dati</h2>
             <div class="flex flex-col md:flex-row gap-6 items-center">
                 <div class="flex-1 w-full">
                    <label for="st-file-uploader" class="block text-sm font-medium text-gray-700 mb-1">Carica il tuo file CSV "0.5HT"</label>
                    <input type="file" id="st-file-uploader" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                </div>
                <button id="st-import-btn" class="w-full md:w-auto bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700 shadow-sm flex items-center gap-2 justify-center">
                    <span class="btn-text">Carica e Analizza 1T</span>
                    <div class="loader-sm hidden"></div>
                </button>
             </div>
        </div>

        <div id="st-results-container" class="hidden">
            <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                    <dt class="truncate text-sm font-medium text-gray-500">Partite Analizzate</dt>
                    <dd id="st-total-partite" class="mt-1 text-3xl font-semibold tracking-tight text-blue-600">0</dd>
                </div>
                <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                    <dt class="truncate text-sm font-medium text-gray-500">Vinte (0.5HT)</dt>
                    <dd id="st-partite-vinte" class="mt-1 text-3xl font-semibold tracking-tight text-green-600">0</dd>
                </div>
                <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                    <dt class="truncate text-sm font-medium text-gray-500">Perse (0.5HT)</dt>
                    <dd id="st-partite-perse" class="mt-1 text-3xl font-semibold tracking-tight text-red-600">0</dd>
                </div>
                <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
                    <dt class="truncate text-sm font-medium text-gray-500">% Vinte (0.5HT)</dt>
                    <dd id="st-percentuale-vinte" class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">0.0%</dd>
                </div>
            </div>
             <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                 <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                     <h2 class="text-2xl font-semibold">Risultati Analisi</h2>
                     <div class="flex gap-2">
                         <button id="st-calculate-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 text-sm flex items-center gap-2 justify-center">
                            <span class="btn-text">Calcola Risultati 2T</span>
                            <div class="loader-sm hidden"></div>
                        </button>
                        <button id="st-export-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm">Esporta CSV</button>
                     </div>
                 </div>
             </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data</th>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Partita</th>
                                <th class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lega</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ris. FT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ris. HT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Esito 0.5HT</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Esito 2T</th>
                                <th class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="st-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    
    <script type="module">
        // --- CONFIGURAZIONE CHIAVE API ---
        const API_KEY = "AIzaSyB9UHe0WirATu8KhHdH7dNdmcbhnaKKy6I";
        
        // --- Variabili Globali ---
        let stAnalyzedData = []; // Cache in memoria (NO DB)

        // --- Elementi del DOM ---
        const ui = {
            stFileUploader: document.getElementById('st-file-uploader'),
            stImportBtn: document.getElementById('st-import-btn'),
            stResultsContainer: document.getElementById('st-results-container'),
            stTotalPartite: document.getElementById('st-total-partite'),
            stPartiteVinte: document.getElementById('st-partite-vinte'),
            stPartitePerse: document.getElementById('st-partite-perse'),
            stPercentualeVinte: document.getElementById('st-percentuale-vinte'),
            stTableBody: document.getElementById('st-table-body'),
            stExportBtn: document.getElementById('st-export-btn'),
            stCalculateBtn: document.getElementById('st-calculate-btn'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            modalCloseBtnX: document.getElementById('modal-close-btn-x'),
            editModal: document.getElementById('edit-modal'),
            editModalMatchInfo: document.getElementById('edit-modal-match-info'),
            editModalCloseBtnX: document.getElementById('edit-modal-close-btn-x'),
            editModalSaveBtn: document.getElementById('edit-modal-save-btn'),
            editForm: document.getElementById('edit-form'),
            editRowId: document.getElementById('edit-row-id'),
            editFtScore: document.getElementById('edit-ft-score'),
            editHtScore: document.getElementById('edit-ht-score'),
        };
        
        // --- Funzioni di Utility ---
        const showLoaderOnButton = (button) => {
            button.disabled = true;
            const btnText = button.querySelector('.btn-text');
            if (btnText) btnText.classList.add('hidden');
            const loader = button.querySelector('.loader-sm');
            if(loader) loader.classList.remove('hidden');
        };
        
        const hideLoaderOnButton = (button, originalText) => {
            button.disabled = false;
            const btnText = button.querySelector('.btn-text');
            if(btnText) {
                btnText.textContent = originalText;
                btnText.classList.remove('hidden');
            }
            const loader = button.querySelector('.loader-sm');
            if(loader) loader.classList.add('hidden');
        };
        
        const showModal = (title, message, type = 'info', onConfirm = null) => {
            ui.modalTitle.textContent = title;
            ui.modalBody.innerHTML = message;
            
            ui.modalCancelBtn.classList.add('hidden');
            ui.modalConfirmBtn.onclick = () => hideModal();
            
            if (onConfirm) {
                ui.modalCancelBtn.classList.remove('hidden');
                ui.modalConfirmBtn.onclick = () => {
                    hideModal();
                    onConfirm();
                };
            }

            const titleBaseClasses = 'text-xl font-bold';
            const buttonBaseClasses = 'text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 shadow-sm';
            
            if (type === 'error') {
                ui.modalTitle.className = `${titleBaseClasses} text-red-700`;
                ui.modalConfirmBtn.className = `${buttonBaseClasses} bg-red-600 hover:bg-red-700`;
            } else {
                ui.modalTitle.className = `${titleBaseClasses} text-gray-800`;
                ui.modalConfirmBtn.className = `${buttonBaseClasses} bg-violet-600 hover:bg-violet-700`;
            }
            
            ui.modal.classList.remove('hidden');
        };

        const hideModal = () => {
            ui.modal.classList.add('hidden');
        }

        ui.modalConfirmBtn.addEventListener('click', hideModal);
        ui.modalCancelBtn.addEventListener('click', hideModal);
        ui.modalCloseBtnX.addEventListener('click', hideModal);
        

        // --- Logica Principale ---
        
        // --- BLOCCO MODIFICATO: Parsing Streaming con `step` + UI Fix + ID Fix ---
        ui.stImportBtn.addEventListener('click', () => {
            const file = ui.stFileUploader.files[0];
            if (!file) {
                showModal('Attenzione', "Per favore, seleziona un file CSV per l'analisi.");
                return;
            }
            showLoaderOnButton(ui.stImportBtn);
            
            stAnalyzedData = []; // Resetta l'array ad ogni caricamento
            let isFirstRow = true; 
            let rowIndexCounter = 0; // Contatore per ID univoco

            console.log("Avvio parsing streaming...");
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                step: function(results, parser) {
                    const row = results.data;
                    
                    if(isFirstRow) {
                        console.log("Nomi colonne visti da PapaParse:", Object.keys(row));
                        isFirstRow = false;
                    }

                    // --- PULIZIA DATI RIGA PER RIGA ---
                    let esitoValue = row['Esito (0,5HT)'] || row['Esito (0.5HT)'] || 'N/D';
                    
                    for (const key in row) {
                        if (typeof row[key] === 'string') {
                            row[key] = row[key].replace(/\\s?/g, '').trim();
                        }
                    }
                    // --- CORREZIONE RISULTATO FT ---
                    const risultatoFinale = row['Risultato'] || ''; 

                    if (row['Data'] && row['Partita']) {
                        // --- CORREZIONE ID UNIVOCO ---
                        // Usiamo Data + Partita + Indice Progressivo
                        const uniqueId = `${row['Data']}-${row['Partita']}-${rowIndexCounter}`;
                        rowIndexCounter++; // Incrementa per la prossima riga

                        stAnalyzedData.push({
                            id: uniqueId,
                            data: row['Data'],
                            lega: row['Lega'],
                            partita: row['Partita'],
                            risultatoFT: risultatoFinale, // Usa il valore corretto
                            esito1T: esitoValue, 
                            risultatoHT: null,
                            esito2T: 'PENDING'
                        });
                    } else {
                        console.warn("Riga saltata per dati mancanti:", row);
                    }
                },
                complete: function() {
                    console.log("Parsing streaming COMPLETATO.", stAnalyzedData.length, "righe processate.");
                    
                    if (stAnalyzedData.length === 0) {
                        showModal('Errore di Caricamento', "Nessun dato valido trovato nel file CSV.", 'error');
                    } else {
                        updateStats();
                        renderStTable(stAnalyzedData);
                        ui.stResultsContainer.classList.remove('hidden');
                        showModal('Caricamento Riuscito', `Caricate ${stAnalyzedData.length} partite.`);
                    }
                    
                    hideLoaderOnButton(ui.stImportBtn, 'Carica e Analizza 1T');
                    ui.stFileUploader.value = '';
                },
                error: function(error, file) {
                    console.error("Errore PapaParse (streaming):", error);
                    showModal('Errore di Parsing', `Impossibile analizzare il file CSV: ${error.message}`, 'error');
                    hideLoaderOnButton(ui.stImportBtn, 'Carica e Analizza 1T');
                },
                encoding: "windows-1252" 
            });
        });
        // --- FINE BLOCCO MODIFICATO ---


        // --- Logica Calcolo 2T (V11 - 0.5HT Ottimizzata) ---
        ui.stCalculateBtn.addEventListener('click', async () => {
            showLoaderOnButton(ui.stCalculateBtn);
            ui.stExportBtn.disabled = true;
            
            let googleCalls = 0;
            let rowsToUpdate = 0;
            let rowsSkipped = 0; // Contatore per righe già calcolate

            console.log("--- Inizio Calcolo Risultati 2T ---");

            for(let i=0; i<stAnalyzedData.length; i++) {
                const row = stAnalyzedData[i];
                let rowUpdated = false;

                // Salta se non è PENDING
                if (row.esito2T !== 'PENDING') {
                    rowsSkipped++;
                    // console.log(`Riga ${i+1} (${row.partita}) già calcolata (${row.esito2T}), skip.`);
                    continue; 
                }

                console.log(`Processing riga ${i+1}: ${row.partita}, Esito1T: ${row.esito1T}, FT: ${row.risultatoFT}`);

                // 1. LOGICA PERSA (0-0 HT)
                if (row.esito1T === 'PERSA') {
                    console.log(`   -> Logica 0.5HT (PERSA). Imposto HT=0-0.`);
                    row.risultatoHT = '0-0';
                    // Controlla che FT sia valido prima di calcolare 2T
                    if (row.risultatoFT && /^\d+-\d+$/.test(row.risultatoFT)) {
                         row.esito2T = (row.risultatoFT !== '0-0') ? 'VINTA' : 'PERSA';
                    } else {
                         row.esito2T = 'N/D'; // FT non valido
                         console.warn(`   -> FT non valido (${row.risultatoFT}), Esito2T impostato a N/D`);
                    }
                    rowUpdated = true;
                
                // 2. LOGICA VINTA 1-0 / 0-1 (HT = FT)
                } else if (row.esito1T === 'VINTA' && (row.risultatoFT === '1-0' || row.risultatoFT === '0-1')) {
                    console.log(`   -> Logica 0.5HT (VINTA 1-0/0-1). Imposto HT = FT.`);
                    row.risultatoHT = row.risultatoFT;
                    row.esito2T = 'PERSA'; // Gol 2T = 0
                    rowUpdated = true;

                // 3. LOGICA VINTA (ALTRI RISULTATI) -> Cerca su Google
                } else if (row.esito1T === 'VINTA') {
                    console.log(`   -> Logica 0.5HT (VINTA >1 gol). Chiamo Google...`);
                    const [home, away] = row.partita.split(' - ');
                    const dataPartita = new Date(row.data).toLocaleDateString('it-IT');
                    const query = `risultato primo tempo ${home} ${away} ${dataPartita} ${row.lega}`;
                    googleCalls++;
                    console.log(`      Query: ${query}`);
                    
                    try {
                        const result = await callGeminiAPI(query);
                        console.log(`      Risposta Gemini:`, result);
                        row.risultatoHT = result.ht_score || 'N/D';
                        
                        if (row.risultatoHT && row.risultatoHT !== 'N/D' && /^\d+-\d+$/.test(row.risultatoHT) && 
                            row.risultatoFT && /^\d+-\d+$/.test(row.risultatoFT)) {
                           const [ht1, ht2] = row.risultatoHT.split('-').map(Number);
                           const [ft1, ft2] = row.risultatoFT.split('-').map(Number);
                           const stGoals = (ft1 - ht1) + (ft2 - ht2);
                           row.esito2T = stGoals > 0 ? 'VINTA' : 'PERSA';
                           console.log(`      HT:${row.risultatoHT}, FT:${row.risultatoFT} => Gol 2T:${stGoals}, Esito2T:${row.esito2T}`);
                        } else {
                           row.esito2T = 'N/D';
                           console.warn(`      HT (${row.risultatoHT}) o FT (${row.risultatoFT}) non valido/trovato, Esito2T impostato a N/D`);
                        }
                    } catch (e) {
                         console.error(`      Errore Gemini per ${row.partita}:`, e);
                         row.esito2T = 'N/D';
                    }
                    rowUpdated = true;
                    await new Promise(resolve => setTimeout(resolve, 600)); // Pausa leggermente aumentata
                
                // Caso imprevisto (es. Esito1T è N/D)
                } else {
                     console.warn(`   -> Caso non gestito per ${row.partita}. Esito1T: ${row.esito1T}. Imposto N/D.`);
                     row.risultatoHT = 'N/D';
                     row.esito2T = 'N/D';
                     rowUpdated = true;
                }
                
                if (rowUpdated) {
                    rowsToUpdate++;
                    // Non serve salvare nel DB qui perché non c'è DB
                    renderStTable(stAnalyzedData); // Aggiorna la UI
                }
            }
            
            console.log("--- Fine Calcolo Risultati 2T ---");
            hideLoaderOnButton(ui.stCalculateBtn, 'Calcola Risultati 2T');
            ui.stExportBtn.disabled = false;
            showModal('Analisi Completata', `Calcolo terminato. ${rowsToUpdate} righe elaborate. ${rowsSkipped} righe già calcolate. Sono state effettuate ${googleCalls} nuove ricerche.`);
        });
        
         function renderStTable(data) {
            ui.stTableBody.innerHTML = '';
            data.forEach((m) => {
                let esito2TClass = 'bg-gray-200 text-gray-800';
                if (m.esito2T === 'VINTA') esito2TClass = 'win';
                if (m.esito2T === 'PERSA') esito2TClass = 'lose';
                if (m.esito2T === 'N/D') esito2TClass = 'pending';

                let esito1TClass = 'pending';
                if (m.esito1T === 'VINTA') esito1TClass = 'win';
                if (m.esito1T === 'PERSA') esito1TClass = 'lose';

                const row = `
                    <tr class="hover:bg-gray-50" data-id="${m.id}">
                        <td class="table-cell text-sm text-gray-600">${new Date(m.data).toLocaleDateString('it-IT')}</td>
                        <td class="table-cell font-medium text-gray-900">${m.partita}</td>
                        <td class="table-cell text-sm text-gray-600">${m.lega}</td>
                        <td class="table-cell text-center font-mono">${m.risultatoFT}</td>
                        <td class="table-cell text-center font-mono">${m.risultatoHT || '...'}</td>
                        <td class="table-cell text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${esito1TClass}">${m.esito1T}</span></td>
                        <td class="table-cell text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${esito2TClass}">${m.esito2T}</span></td>
                        <td class="table-cell text-center">
                             <div class="flex justify-center items-center gap-1">
                                <button class="edit-st-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${m.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="delete-st-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${m.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                ui.stTableBody.innerHTML += row;
            });
        }
        
         ui.stExportBtn.addEventListener('click', () => {
            if (stAnalyzedData.length === 0) {
                showModal('Esportazione non possibile', 'Nessun dato da esportare.', 'error');
                return;
            }
            // Clona i dati e rimuove l'ID interno prima di esportare
            const exportData = stAnalyzedData.map(({ id, ...rest }) => rest); 
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = Object.keys(exportData[0]);
            csvContent += headers.join(",") + "\r\n";

            exportData.forEach(row => {
                const rowValues = headers.map(header => `"${String(row[header]).replace(/"/g, '""')}"`);
                csvContent += rowValues.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "analisi_secondo_tempo.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        ui.stTableBody.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const rowId = button.dataset.id;
            const rowIndex = stAnalyzedData.findIndex(r => r.id === rowId);
            if (rowIndex === -1) return; 
            
            const rowData = stAnalyzedData[rowIndex];
            
            if (button.classList.contains('edit-st-btn')) {
                 ui.editRowId.value = rowId;
                 ui.editModalMatchInfo.textContent = rowData.partita;
                 ui.editFtScore.value = rowData.risultatoFT || '';
                 // Mostra N/D se null o vuoto
                 ui.editHtScore.value = (rowData.risultatoHT && rowData.risultatoHT !== 'N/D') ? rowData.risultatoHT : ''; 
                 ui.editModal.classList.remove('hidden');
            } else if (button.classList.contains('delete-st-btn')) {
                showModal('Conferma Cancellazione', `Sei sicuro di voler cancellare la partita: ${rowData.partita}?`, 'error', () => {
                    stAnalyzedData.splice(rowIndex, 1);
                    renderStTable(stAnalyzedData);
                    updateStats();
                });
            }
        });
        
        function updateStats() {
            const totali = stAnalyzedData.length;
            const vinte = stAnalyzedData.filter(r => r.esito1T === 'VINTA').length;
            const perse = totali - vinte;
            const winrate = totali > 0 ? (vinte / totali) * 100 : 0;
            
            ui.stTotalPartite.textContent = totali;
            ui.stPartiteVinte.textContent = vinte;
            ui.stPartitePerse.textContent = perse;
            ui.stPercentualeVinte.textContent = `${winrate.toFixed(1)}%`;
        }

        ui.editModalSaveBtn.addEventListener('click', () => { 
            const rowId = ui.editRowId.value;
            const rowIndex = stAnalyzedData.findIndex(r => r.id === rowId);
            if (rowIndex === -1) return;

            const ftScore = ui.editFtScore.value.trim();
            // Permetti HT vuoto, che verrà convertito in N/D
            const htScoreInput = ui.editHtScore.value.trim(); 
            const htScore = htScoreInput || 'N/D'; // Se vuoto, imposta N/D

            // Validazione: FT deve essere X-Y. HT può essere X-Y o N/D (vuoto)
            if (!/^\d+-\d+$/.test(ftScore) || (htScoreInput && !/^\d+-\d+$/.test(htScoreInput))) {
                 showModal('Errore', 'Formato risultato FT non valido (usa X-Y). HT può essere X-Y o vuoto.', 'error');
                return;
            }

            const row = stAnalyzedData[rowIndex];
            row.risultatoFT = ftScore;
            row.risultatoHT = htScore; // Salva N/D se era vuoto

            // Ricalcola Esito 2T
            // Solo se HT e FT sono validi (non N/D e nel formato corretto)
            if (row.risultatoHT && row.risultatoHT !== 'N/D' && /^\d+-\d+$/.test(row.risultatoHT) && 
                row.risultatoFT && /^\d+-\d+$/.test(row.risultatoFT)) {
               const [ht1, ht2] = row.risultatoHT.split('-').map(Number);
               const [ft1, ft2] = row.risultatoFT.split('-').map(Number);
               const stGoals = (ft1 - ht1) + (ft2 - ht2);
               row.esito2T = stGoals > 0 ? 'VINTA' : 'PERSA';
            } else {
                row.esito2T = 'N/D'; // Se HT o FT non sono validi, 2T è N/D
            }
            
            renderStTable(stAnalyzedData);
            ui.editModal.classList.add('hidden');
        });
        
        async function callGeminiAPI(userQuery, retries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;

            const systemPrompt = `Sei un assistente per dati sportivi. Rispondi SEMPRE E SOLO con un oggetto JSON. Il JSON deve avere la chiave "ht_score". Se trovi il risultato del primo tempo (Half Time), valorizzalo come stringa (es. "1-0"). Se non lo trovi o non sei sicuro, il valore deve essere null. Esempio: {"ht_score": "1-0"}. Non aggiungere mai altro testo.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 503 && i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, (i + 1) * 2000));
                        continue;
                    }

                    if (!response.ok) {
                         const errorBody = await response.text();
                         console.error(`API Error Status: ${response.status}, Body: ${errorBody}`);
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    // Logga la risposta grezza di Gemini
                    // console.log("Risposta API grezza:", JSON.stringify(result, null, 2)); 
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        console.warn("Nessun testo trovato nella risposta API per:", userQuery);
                        return { ht_score: null };
                    }
                    
                    try {
                        const cleanText = text.replace(/```json\n?|\n?```/g, '');
                        // Aggiungo un try-catch più specifico per il JSON
                        try {
                            const parsedJson = JSON.parse(cleanText);
                            // Controllo aggiuntivo: verifica che ht_score sia una stringa X-Y o null
                            if (parsedJson.ht_score === null || /^\d+-\d+$/.test(parsedJson.ht_score)) {
                                return parsedJson;
                            } else {
                                console.warn(`Formato ht_score non valido ('${parsedJson.ht_score}') nel JSON parsato per:`, userQuery);
                                return { ht_score: null }; // Ritorna null se il formato non è corretto
                            }
                        } catch (jsonError) {
                             console.error("Errore nel parsing del JSON:", cleanText, "Errore:", jsonError);
                             return { ht_score: null };
                        }
                    } catch (e) {
                         // Questo catch esterno è meno probabile ora, ma lo tengo per sicurezza
                         console.error("Errore generico nella pulizia/parsing del testo:", text, "Errore:", e);
                         return { ht_score: null };
                    }
                } catch (error) {
                    console.error(`Errore fetch nel tentativo ${i + 1} per ${userQuery}:`, error);
                    if (i === retries - 1) {
                         // Non rilanciare l'errore, ma ritorna null per permettere al ciclo di continuare
                         return { ht_score: null }; 
                    }
                    await new Promise(resolve => setTimeout(resolve, (i + 1) * 1500)); // Pausa prima del retry
                }
            }
             // Se tutti i tentativi falliscono, ritorna null
             console.error("Tutti i tentativi API falliti per:", userQuery);
             return { ht_score: null }; 
        }

    </script>
</body>
</html>